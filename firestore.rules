rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================= LISTINGS =================
    match /listings/{listingId} {
      allow read: if true;
      allow write: if request.auth != null;

      match /reviews/{reviewId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null;
      }
    }

    // ================= USERS =================
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /favorites/{listingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ================= CHATS =================
    match /chats/{chatRoomId} {
      allow read, write: if request.auth != null;

      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow create, update, delete: if request.auth != null;
      }
    }

    // ================= VISIT REQUESTS =================
    match /visit_requests/{requestId} {

      allow create: if request.auth != null &&
                    request.resource.data.tenantId == request.auth.uid;

      allow read: if request.auth != null &&
        (
          resource != null &&
          (
            resource.data.tenantId == request.auth.uid ||
            resource.data.ownerId == request.auth.uid
          )
        );

      allow update: if request.auth != null &&
        (
          resource != null &&
          (
            resource.data.tenantId == request.auth.uid ||
            resource.data.ownerId == request.auth.uid
          )
        );
    }

    // ================= GLOBAL REVIEWS COLLECTION =================
    match /reviews/{reviewId} {
      allow create: if request.auth != null;
      allow read: if true;
      allow update, delete: if request.auth != null &&
                            resource != null &&
                            request.auth.uid == resource.data.reviewerId;
    }

  }
}
